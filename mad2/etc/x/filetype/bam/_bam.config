decompress: &bam_decompress
  description: 'convert Bam to Sam'
  run_when: '"{{fullpath}}" -nt "{{output}}"'
  defaults:
    output: "{{ basename|re_sub('.bam$', '.sam') }}"
  annotate:
    createdWith: "Samtools $(samtools 2>&1 | grep Version)"
  command: |
    samtools view -h {{ fullpath }} > {{ output }}
sam:
  << bam_decompress
stats:
  description: 'run flagstats'
  defaults:
    output: "{{ basename|re_sub('.sam$', '.flagstat') }}"
    annotate:
      createdWith: "Samtools $(samtools 2>&1 | grep Version)"
  command: |
    samtools flagstat {{ fullpath }} > {{ output }}
coveragebg:
  description: create a coverage bedgraph
  defaults:
    createdWith: '$(bedtools --version)'
    output: '{{ basename|re_sub(".bam$", "") }}.bedgraph'
  output_files:
    - '{{ output }}'
  command: |
    bedtools genomecov \
        -ibam {{ fullpath }} \
        -bga -split \
        | bgzip -c \
        > {{ output }} ;
        tabix -p bed {{ output }}
htseq_count:
  description: 'Count reads using htseq-count'
  path:
    - /ddn1/vol1/leuven_groups/lts_00002/software/samtools/current
  defaults:
    pbs_mem: 8gb
    htseq_stranded: "no"
    htseq_minqual: 0
    genome_gtf_file: "/ddn1/vol1/leuven_groups/lts_00002/lcb/resources/mouse/{{genome_build}}/{{genome_build}}.gtf"
    htseq_idattr: gene_id
    htseq_mode: union
    htseq_feature_type: exon
    output: '{{ sample_name }}.counts'
  virtualenv: /user/leuven/306/vsc30690/local/vem
  output_files:
    - '{{ sample_name }}.counts'
  command: |
    samtools view -f 2 \
      "{{ fullpath }}" \
      | htseq-count \
        --format=sam \
        --order=pos \
        --idattr={{ htseq_idattr }} \
        --stranded={{ htseq_stranded }} \
        --mode={{ htseq_mode }} \
        --type={{ htseq_feature_type }} \
        - \
        "{{ genome_gtf_file }}" \
        > "{{ sample_name }}.counts"
mpileup:
  path:
    - /ddn1/vol1/leuven_groups/lts_00002/software/samtools/current/
    - /ddn1/vol1/leuven_groups/lts_00002/software/samtools/current/bcftools/
  defaults:
    mpileup_min_mapq : 1
    mpileup_min_baseq : 13
    mpileup_max_per_bam_depth_snvs : 8000
    mpileup_max_per_bam_depth_indels : 8000
    genome_fasta: "/ddn1/vol1/leuven_groups/lts_00002/lcb/resources/mouse/{{genome_build}}/{{genome_build}}.fa"

  command: |
    samtools mpileup \''
        -d "{{ mpileup_max_per_bam_depth_snvs }}" \
        -L "{{ mpileup_max_per_bam_depth_indels }}" \
        -q "{{ mpileup_min_mapq }}" \
        -Q "{{ mpileup_min_baseq }}" \
        -u -D -S \
        -f "{{ genome_fasta }}" \
        "${bam_files_array[@]}" \
      #   | bcftools view -bvcg - > "${bcf_file}";

      #   "${bam_files_array[@]}" \
      # | "${BCFTOOLS}" view -bvcg - > "${bcf_file}";
